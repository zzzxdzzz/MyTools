* Goddard IDL Astronomy User's Library (http://idlastro.gsfc.nasa.gov) to
  use this package
* mpfit.pro (http://www.physics.wisc.edu/~craigm/idl/fitting.html) included in
  this package
* goodpoly.pro with supporting routines from Marc Buie's personal library
  (https://www.boulder.swri.edu/~buie/idl/) also included in this package

Top level procedure
===================

photmods.pro
photcorrs.pro
boloalbedos.pro

All programs have similar calling signatures.

photmods.pro is the top-level routine for photometric modeling.  It uses an
ASCII configuration file (PhotModS.conf).  It can be called in the following
forms:

To display manual:

IDL> photmods, /manual

To print out calling signature:

IDL> photmods, /help

To fit model in a fully automatic mode with everything specified in the default
configuration file:

IDL> photmods

The full API for PhotModS is:

photmods[, infile][, outfile][, configuration=...][, model=...]
        [, /verbose][, /help][, /manual]

* `infile' and `outfile' are the names of input PDIF and output FITS files
* `configuration' specifies the configuration file
* `model' specifies the models to be fitted.  If set, then it will override
  the models specified in the configuration file
* `help' prints the calling signature
* `manual' displays the program manual.
* Keyword parameters override those same keys in the configuration file

See package_org_chart.pdf for the flow charts of all programs.



Configuration files
===================

phopar_sis.csv       Photometric model parameter output file format SIS
specdata_sis.csv     Spectral data output file format SIS
boloalbedo_sis.csv   Bolometric Bond albedo output file format SIS
photmods.conf        photmods fitting routine configuration file
photcorrs.conf       photcorrs routine configuration file
boloalbedos.conf     boloalbedos configuration file

All configuration files are ASCII files and can be opened by any text editor.


phopar_sis.csv, specdata_sis.csv, boloalbedo_sis.csv:

These files contain the SIS format for the output FITS files.  They are
coma-separated value and can be opened and edited with Microsoft Excel, as
well as any text editor.


photmods.conf, photcorrs.conf, boloalbedos.conf

These are the respective configuration files for photmods.pro, photcorrs.pro,
and boloalbedos.pro, respectively.  They have one set of `key' = value in each
line.  The lines starts with '#' are comment lines and will be ignored by
program.

These files define all information required by those pipelines, providing a
flexible way to configure a large number of photometric modeling and
correction parameters.  Users can edit these files for their specific
configuration for running the program, but should never change the names
of keys and the format of these configuration files.

Should more parameters need to be implemented in the future, then they can be
simply added to this configuration file, and the loader module load_conf.pro
as well as other relevant code will be revised accordingly.



Detailed information about the package routines
=============================================================================


Photometric functions
=====================

lommel_seeliger_model.pro   Lommel-Seeliger model
lommel_seeliger.pro         Lommel-Seeliger disk function
ls_int.pro                  Lommel-Seeliger integrated term
ls_intphasefunc.pro         Lommel-Seeliger disk-integrated phase function
rolo_model.pro              ROLO model
rolo_phasefunc.pro          ROLO single-scattering phase function
rolo_intphasefunc.pro       ROLO disk-integrated phase function
minnaert_model.pro          Minnaert model
minnaert.pro                Minnaert disk function
minnaert_phasefunc.pro      Minnaert single-scattering phase function
minnaert_intphasefunc.pro   Minnaert disk-integrated phase function
mcewen_model.pro            McEwen model
mcewen.pro                  McEwen disk function
mcewen_intphasefunc.pro     McEwen disk-integrated phase function
akimov_model.pro            Akimov model
akimov.pro                  Akimov disk-funciton
akimov_phasefunc.pro        Akimov single-scattering phase function
akimov_intphasefunc.pro     Akimov disk-integrated phase function
expoly.pro                  Exponential polynomial phase function
lambert.pro                 Lambert disk function
lambert_int.pro             Lambert integrated term

The naming convention of these functions are:
1. All names start with the model name.  `lommel-seeliger` is sometimes taken
   as `ls`.
2. The ending of the names indicates the type of models implemented:
   `_model`: top level disk-resolved photometric model
   ``: (no ending) disk-function
   `_phasefunc`: phase function model
   `_int`: integrated form of disk-function model
   `_intphasefunc`: disk-integrated phase function
3. Exceptions:
   `expoly`: exponential polynomial model for phase function


APIs:

The APIs of all four photometric models functions follow the same form:

    ref = rolo_model(pha, inc, emi, p1, p2, p3, ...[, /deriv]
                     [, /radf | /reff | /brdf])

By default, program returns the reflectance quantity for the input
photometric parameters and geometries with the specified model in a 1-D
array of M elements, where M is number of scattering geometries in
(pha, inc, emi).  Keywords `radf', `reff', and `brdf' control the program
to return RADF, REFF, and BRDF respectively.

If `deriv' is set, then program returns the model reflectance and
derivatives w/r to the model parameters in a 2-D array of dimensions NxM,
where N is the number of parameters in the model, so that [0,*] is the model
reflectance and [1:*,*] is the derivatives.

* `pha', `inc', `emi' are phase angle, incidence angle, and
  emission angle in degrees.
* p1, p2, p3, ... are the model parameters specific to the particular
  model called.  See below for the specific API for each model.
* `radf' and `reff' are two optional keyword parameters that, if set, change
  the default return to RADF and REFF, respectively.  If both keywords are set,
  then `radf' overrides `reff' and program returns RADF.

Specific API of each function:

ref = lommel_seeliger_model(pha, inc, emi, a_ls, p1, p2, p3[, /deriv]
                        [, /radf | /reff | /brdf])
ref = rolo_model(pha, inc, emi, c0, c1, a0, a1, a2, a3, a4[, /deriv]
                        [, /radf | /reff | /brdf])
ref = minnaert_model(pha, inc, emi, a_m, p1, p2, p3, k0, b[, /deriv]
                        [, /radf | /reff | /brdf])
ref = mcewen_model(pha, inc, emi, a_mc, p1, p2, p3, p4, p5, p6[, /deriv]
                        [, /radf | /reff | /brdf])
ref = akimov_model(pha, inc, emi, a_mc, p1, p2, p3[, /deriv]
                        [, /radf | /reff | /brdf])

APIs of disk-functions:

d = lommel-seeliger(inc, emi)
d = minnaert(inc, emi, k[, /deriv])
d = mcewen(pha, inc, emi, p1, p2, p3[, /deriv])
d = akimov(inc, emi, pha[, eta=1.])

* `inc`, `emi`, `pha` are incidence angle, emission angle, and phase angle,
  respectively
* `k`, `p1`, `p2`, `p3`, `eta`: disk-function parameters
* `deriv`: return derivatives or not

APIs of phase functions:

f = rolo_phasefunc(pha, c0, c1, a0, a1, a2, a3, a4[, /deriv])
f = minnaert_phasefunc(pha, p1, p2, p3[, /deriv])
f = akimov(pha, m, u1, u2)

* `pha`: phase angle
* `c#`, `a#`, `p#`, `m`, `u#`: phase function parameters
* `deriv`: return derivatives or not

APIs of integrated forms of disk-function:

Phi = ls_int(pha)
Phi = lambert_int(pha)

* `pha`: phase angle

APIs of disk-integrated phase function:

Phi = ls_intphasefunc(pha, p1, p2, p3[, a_ls=1])
Phi = rolo_intphasefunc(pha, c0, c1, a0, a1, a2, a3, a4[, /normalization])
Phi = minnaert_intphasefunc(pha, p1, p2, p3, k0, b[, a_m=1])
Phi = mcewen_intphasefunc(pha, p1, p2, p3, p4, p5, p6[, a_mc=1])
Phi = akimov_intphasefunc(pha, p1, p2, p3[, a_ak=1])

* `pha`: phase angle
* `p#`, `c#`, `a#`, `k0`, `b`: modle parameters
* `a_ls`, `a_m`, `a_mc`, `a_ak`: albedo parameter
* `normalization`: normalize phase function or not

API of `expoly`:

f = expoly(pha, par[, /deriv])

* `pha`: phase angle
* `par`: polynomial parameters
* `deriv`: return derivatives or not


Auxiliary functions
===================

refquant.pro           Reflectance quantity conversion
phot_model.pro         Wrapper for all four photometric models
bolometric.pro         Calculate bolometric quantity
phase_func.pro         Wrapper for all disk-integrated phase function models
phase_integral.pro     Calculate phase integral for all four models


refquant.pro : Convert bidirectional reflectance to other reflectance quantity

API:  quantity = refquant(bdr[, inc][, /radf | /reff | /brdf]
                             [, from='radf'|'reff'|'brdf'])

Program returns the reflectance quantity specified by keyword.  If no keyword
is specified, then nothing is done and the input `bdr' is returned.

* `bdr' is bidirectional reflectance
* `inc' is incidence angle in degrees.  It is optional and only required when
  calculating REFF and BRDF
* Keywords `radf', `reff', and `brdf' controls the output quantity.  If more
  than one keyword is set, then the order of override is
      `radf'  >  `reff'  >  `brdf'
  E.g., if both `radf' and `brdf' are set, then program will return `radf';
  or if `reff' and `brdf' are both set, then program will return `reff'.
* `from' specifies the type of input quantity


phot_model.pro : Wrapper function to provide one interface for all photometric
model functions.

API :  ref = phot_model(model, pha, inc, emi, p[, /radf | /reff | /brdf])

* `model' specifies the photometric model ('lommel-seeliger', 'rolo',
  'minnaert', and 'mcewen').
* `pha', `inc', `emi' are the scattering angles in degrees
* `p' is an array with the photometric model parameters in the order of their
  respective routines


bolometric.pro : Calculate the bolometric quantity for the input spectrum

API :  bolo = bolometric(q, wave[, solar=...])

* `q' is an array of spectrum
* `wave' is an array of wavelength in nm
* `solar' is an Nx2 array, containing the wavelength (nm) and solar spectrum.
  If not specified, it will load the solar spectrum from 'solar_flux.txt' file


API for phase_func.pro:
    phi = phase_func(model, p, pha[, /normalized])

Program returns the disk-integrated phase function for `model' with parameters
`p' at phase angle(s) `pha'.

* `model' is a string to specify the photometric model
* `p' is an array containing the photometric parameters
* `pha' is a scaler or an array of phase angle(s) in degrees
* `normalized' specify whether the calculated phase function is normalized to
  unity at zero phase angle.  Otherwise the value of phase function at zero
  phase angle is the geometric albedo.


API for phase_integral.pro:
    q = phase_integral(model, p[, /russell][, flag=variable])

Program returns the phase integral for `model' with parameters `p'.

* `model' and `p' are the same as phase_func.pro
* `russell' makes the program to calculate phase integral based on the
  Russell's law approximation: q ~ 2.14 Phi(54 deg).
* `flag' returns a 16-bit quality flag of output.  0 means good, 1-8 bits mark
  non-fatal problems, and 9-16 bits mark fatal problem.
    Bit flags:
      1  - Calculation with Russell's law
      2  - Math error detected (overflow, underflow, infinity
           etc.)
      14 - Numerical integration error
      15 - Non-monotonic phase function detected
      16 - All zero photometric parameters received



Photometric modeling
====================

mpfit_phomodel.pro      Fit photometric model with MPFIT
check_phodata.pro       Check the validity of photometric data
bin_phodata.pro         Bin photometric data in scattering parameter space


mpfit_phomodel.pro: fit photometric model with MPFIT

API:  pars = mpfit_phomodel(model, iof, pha, inc, emi[, p0=...][, ioferr=...][, /verbose])

Program returns the best-fit parameters together with the covariance matrix
in a 2D array of Nx(N+1) in dimension

* `iof', `pha', `inc', `emi' are the photometric data to be fitted
* `model' is a string to specify the photometric model.  Options are:
  'lommel-seeliger', 'rolo', 'minnaert', 'mcewen'.  Note that only the
  first five letters in each options are checked by program, so the program
  can tolerant typos after the first five letters.  An error message will
  be printed out if the specified model is not one of the above four, and
  program returns -1.
* `p0' is an array containing the initial parameters for the model fit.  The
  defaults are:
    - Lommel-Seeliger model: [0.1, -3e-3, 2e-9, 7e-7]
    - ROLO model:[0., 0.2, 0.3, 7.0e-4, -1e-4, 1.0e-8, 6.0e-7]
    - Minnaert model: [.1, 0.0, 0., 0., 0.5, 0.05]
    - McEwen model: [0.1, -3e-3, 2e-8, 7e-7]
    - Akimov model: [0.1, -3e-2, 1e-4, 1e-6]
* `ioferr' is an array of measurement error for the input I/F data.  If not
  specified, then the fit will be unweighted.


Program uses outside routine `mpfit.pro' to perform the fit.  See
https://www.physics.wisc.edu/~craigm/idl/fitting.html
for the detailed description and algorithm.


check_phodata.pro: Check validity of photometric data

API:  status = check_phodata(iof, pha, inc, emi[, ioferr=ioferr][, /quiet])

Program returns a status code, and in some cases, the input data are modified
to remove or fix invalid geometry.

* `iof`, `pha`, `inc`, `emi`: I/F data and scattering geometry
* `ioferr`: uncertainties associated with iof data
* `quiet`: Suppress all info message.  Default is to be controlled by system
   variable !quiet.


bin_phodata.pro:  Bin photometric data in scattering geometry parameter space

API:  bin_phodata, iof, pha, inc, emi, iofbin, phabin, incbin, emibin
                [, ioferr][, phaerr][, incerr][, emierr]
                [, phares=phares][, incres=incres][, emires=emires]
                [, error=error]
                [, count=count][, /quiet]

* `iof`, `pha`, `inc`, `emi` are photometric data and scattering geometry
* `iofbin`, `phabin`, `incbin`, `emibin` return binned photometric data
* `ioferr`, `phaerr`, `incerr`, `emierr` return the errros of binned
   photometric data
* `phares`, `incres`, `emires` are the bin size of three angles
* `error` is the measurement error of input `iof`
* `count` returns an array containing the number of original data points
   in each bin
* `quiet` suppress all screen print


Model results processing
=============================

polysmooth_phopar.pro      Smooth photometric parameters with polynomials
best_model.pro             Choose the best photometric model


polysmooth_phopar.pro      Smooth photometric parameters with polynomials

API:  par1 = polysmooth_phopar(par[, x=x][, degree=3][,thresh=3]
                                  [, polypar=variable])

Program smooth out the input photometric parameters, except for the first
parameter, with polynomials.  Program returns the smoothed photometric
parameters in an array of the same dimension/size as input array.

* `par`: photometric parameters in an array
* `x`: the x-axis of the input parameters.  Usually it is wavelength.  If
  omitted, then `par` are considered to be sampled in a uniform x-axis
* `degree`: The degrees of polynomials
* `thresh`: The threshold of robust polynomial fit (with outliers rejection).
   If set to 0, then a direct polynomial fit is performed without outliers
   rejection
* `polyvar`: Returns the polynomial parameters for all photometric parameters


best_model.pro            Choose the best photometric model

API:  best = best_model(quality_file)

Program returns the best photometric model in a string

* `quality_file` is the name of quality file


Photometric correction
======================

photomet.pro           Apply photometric correction

API:  corr_data = photomet(model, p, ref, pha, inc, emi
               [, refpha=...][, refinc=...][, refemi=...]
               [, error=variable][, covar=...][, _extra=...]

Program returns the photometrically corrected reflectance data.

* `model' specifies the photometric model for correction
* `p' contains the photometric model parameters
* `ref' is the reflectance quantity to be corrected.  It is bidirectional
  reflectance by default, but can be RADF (I/F), REFF, or BRDF, as specified
  by `_extra' keywords
* `pha', `inc', `emi' are the scattering angles in degrees
* `refpha', `refinc', `refemi' are the reference scattering angles for
  photometric correction.  Defaults are pha=30, inc=30, emi=0.
* `error' contains the measurement errors for `ref' data.  If supplied in
  a named variable, then it will also returns the photometrically corrected
  errors.
* `covar' contains the covariance matrix of the input parameters
* `_extra' are keywords `/radf', `/reff', `/brdf', to specify the reflectance
  quantity passed by `ref'



I/O functions
=============

load_conf.pro           Load configuration files
load_sis.pro            A general loader for all SIS files
read_solar.pro          Load solar spectrum
read_spec.pro           Read spectral data file
write_spec.pro          Write spectral data file
read_phomodel.pro       Read photometric model from a FITS file
write_phomodel.pro      Write best-fit photometric model to a FITS file
write_bolo.pro          Write bolometric Bond albedo data to a FITS file


load_conf.pro loads the parameters from a configuration file, and return
parameters in a structure.

API:   con = load_conf(filename[, input=...])

* `filename' is the name of configuration file
* `input' is an input structure that will override the same-name parameters
  specified in the configuration file `filename'

Program returns a structure `con' that contains all the parameters as defined
in the configuration file.

A configuration file is an ASCII file with 'key = value' format in each line.
The lines started with # are comments and will be ignored.  The structure `con'
returned by load_conf.pro contains tags with their names defined by the keys
in the configuration file, and values defined by the corresponding values in
the configuration file.  `input' is used to provide an overriding mechanism.
If `input' structure has a tag that exists in the `con' structure, then the
value of that tag defined by the configuration file will be overridden by
the values defined by the `input' structure.


load_sis.pro loads a SIS file and return a FITS header

API:   header = load_sis(sisfile, data[, h2=variable][, /extend][, /verbose])

* `sisfile' is the name of SIS file to be loaded
* `data' is the data based on which the FITS header will be generated
* `h2' keyword returns the header for the binary table extension (if `data' is
   an array of structure)
* `extend' sets whether the header is for a primary FITS segment or extension
* `verbose' sets verbose mode


read_solar.pro reads and returns a solar spectrum

API:   load_solar, infile, wav, flux

* `infile' is a string to specify the file name of input solar spectrum
* `wav' returns the wavelength of solar spectrum in nm
* `flux' returns the flux of solar spectrum in W/[m2 nm]

The purpose of this program is to accommodate the possibly changing format of
input solar spectrum file in the future and keep the output format, and
therefore the code, stable for its caller.


write_phomodel.pro saves the best-fit photometric parameters, corresponding
wavelength, and chi-squared to output file, based on the format defined in
a configuration file.

API:   write_phomodel, model, p, covar, wav, outfile[, prop=...[, sis=...]
                                             [, /overwrite][, /verbose]

* `model' specifies what model to fit.
* `p' contains the best-fit photometric parameters to be saved
* `covar' contains the covariance matrix
* `wav' is the wavelength for the parameter
* `outfile' is the output file name
* `prop' keyword passes a structure with the values to be saved in the output
  FITS headers
* `sis' keyword specifies the SIS format file, default is 'phopar_sis.csv' in
  the same directory as the program file
* `overwrite' keyword will cause the program to overwrite existing output file
* `verbose' is a verbose switch


read_phomodel.pro load the photometric model parameters from a FITS file

API:   p = read_phomodel(infile, model[, sis=...][, parname=variable]
                [, wav=variable][, header=variable][, covar=variable]
                [, /verbose]

* `infile' is the name of input file that contains the photometric model
  parameters.
* `model' is the model name to be loaded
* `sis' keyword specifies the SIS file
* `parname' keyword returns the names of photometric model parameters
* `wav' returns the wavelength of photometric model parameters
* `header' returns the header of photometric model parameter FITS file
* `covar' returns the covariance matrix
* `verbose' taggles verbose mode


read_spec.pro reads in spectral data file.

API:   data = read_spec(infile[, error=variale][, wav=variable]
                              [, info=variable][, header=variable]
                              [, /verbose][...]

Program returns the spectral data stored in input data file in an array.

* `infile' is the name of input data file
* `error' returns the error of input data
* `wav' returns the wavelength of spectra
* `info' returns a structure that contains the aspect data of spectral
  data
* `header' returns the FITS header of input data file
* `verbose' sets the verbose mode
* other keywords that are accepted by mrdfits.pro


write_spec.pro saves spectral data to a FITS file

API:   write_spec, outfile, data, error, wav, info[, prop=...][, sis=...]
                                             [, /overwrite][, /verbose]

* `outfile' is the file name to write the spectral data
* `data' is the spectral data to be written
* `error' is the error associated with `data'
* `info' is the aspect data structure associated with `data'
* `wav' is the wavelength of output spectral data
* `prop' keyword passes values to be saved to the output FITS headers
* `overwrite' sets whether output file is overwritten if exists.  If
  not overwritten, then new data will be appended to the end of existing
  data file.  Default is not overwritten.


write_bolo.pro saves the bolometric Bond albedo to an output FITS file

API:   write_bolo, outfile, boloalbedo, info[, prop=...][, sis=...]
                                            [, /overwrite]

* `outfile' specify the name of output file
* `boloalbedo' is an array of the data to be saved
* `info' is the info structure to be saved to output file as a FITS table
* `prop' keyword passes a structure that has the FITS keyword values to be
   propagated to the output file
* `sis' specifies the SIS file for output
* `overwrite' controls whether the output file will be overwritten if exist



Plotting routine
================


plot_ps.pro       Plot photometric model fitting results
plot_phase.pro    Plot disk-integrated phase function for input parameters
plot_model_quality.pro  Plot the model quality data
plot_simple.pro   Independently plot photometric model fitting results


API:   plot_ps, plotfile, model, p, iof, iofmodel, pha, inc, emi,
                          info[, wav=...]

* `plotfile' is the rootname of plot files
* `model' is the name of photometric model
* `iof' contains the I/F data to be plotted
* `iofmodel' contains the modeled I/F data to be plotted
* `pha', `inc', `emi' are the scattering angles in degrees
* `info' contains the data selection criteria information as specified in the
  PhotModS.conf file.
* `wav' is the wavelength of data and model, and is optional


API:   plot_phase[, model][, p][, infile=infile, bandno=bandno][...]

The model and parameters can either be passed in function parameters, or read
from input file.

* `model' is a string or array of string to specify model name:
* `p' is photometric parameters
* `infile' is a string to specify photometric parameter FITS file
* `bandno' is an integer to specify the band number to be plotted
* `_extra' other keywords accepted by IDL plot


API:   plot_model_quality, quafits, [, phopar=...]

* `quafits' is a string containing the name of input file that has the output
*  quality data
* `phopar' contains photometric parameters.  If provided, then geometric
*  albedo will be calculated and plotted


API of plot_simple is the same to photmods.pro.  The intension is to provide a
facility to make all plots after the model parameters are fitted.



Utility routine
===============

broadcast.pro    Implement Python-like broadcast rule to input array
benchmark.pro    Print out benchmark information
ICD2SIS.pro      Transfer ICD fits to SIS fits
pholatlon.pro    Calculate photometric latitude and longitude
test_phot.pro    Test script for OVIRS photometry software package



Other routines from outside library
===================================

mpfit.pro        MPFIT implementation
goodpoly.pro     Robust polynomial fit from Marc Buie's library
badpar.pro       Supporting routine for `goodpoly`
trimrank.pro     Supporting routine for `goodpoly`
setdefaultvalue.pro   Supporting routine for modfits.pro, from Coyote library
